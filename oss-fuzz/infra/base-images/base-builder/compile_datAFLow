#!/bin/bash -eux

echo -n "Compiling datAFLow to $LIB_FUZZING_ENGINE ..."

export PATH="$SRC/llvm/install/bin:$PATH"
export LD_LIBRARY_PATH="$SRC/llvm/install/lib:${LD_LIBRARY_PATH-}"
export AFL_PATH="$SRC/afl"

#
# Build LIB_FUZZING_ENGINE
#

mkdir -p $WORK/datAFLow
pushd $WORK/datAFLow > /dev/null
$CXX $CXXFLAGS -std=c++11 -O2 -c $SRC/libfuzzer/afl/*.cpp -I$SRC/libfuzzer
ar r $LIB_FUZZING_ENGINE $WORK/datAFLow/*.o
popd > /dev/null
rm -rf $WORK/datAFLow

#
# Build and copy AFL tools necessary for fuzzing
#
pushd $SRC/afl > /dev/null

# Unset CFLAGS and CXXFLAGS while building AFL since we don't want to slow it
# down with sanitizers
INITIAL_CXXFLAGS=$CXXFLAGS
INITIAL_CFLAGS=$CFLAGS
unset CXX
unset CC
unset CXXFLAGS
unset CFLAGS
make clean && AFL_NO_X86=1 make && make -C llvm_mode
CFLAGS=$INITIAL_CFLAGS
CXXFLAGS=$INITIAL_CXXFLAGS

find . -name 'afl-*' -executable -type f | xargs cp -t $OUT
popd > /dev/null

AFL_CC=$SRC/llvm/install/bin/clang
AFL_CXX=$SRC/llvm/install/bin/clang++
CC=$SRC/fuzzalloc-debug/src/tools/dataflow-clang-fast
CXX=$SRC/fuzzalloc-debug/src/tools/dataflow-clang-fast++
LD_LIBRARY_PATH="$SRC/fuzzalloc-release/src/runtime/malloc:$LD_LIBRARY_PATH"
LIBS="-L$SRC/fuzzalloc-release/src/runtime/malloc -lfuzzalloc"

export AFL_CC
export AFL_CXX
export CC
export CXX
export LD_LIBRARY_PATH
export LIBS

echo " done."
