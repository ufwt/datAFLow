#!/bin/bash -eux

echo -n "Compiling datAFLow tags ..."

export PATH="$SRC/llvm/install/bin:$PATH"
export LD_LIBRARY_PATH="$SRC/llvm/install/lib:${LD_LIBRARY_PATH-}"

mkdir -p $WORK/tags
pushd $WORK/tags > /dev/null
$CC -O2 -c $SRC/libfuzzer/standalone/StandaloneFuzzTargetMain.c -I$SRC/libfuzzer
ar r $LIB_FUZZING_ENGINE $WORK/tags/*.o
popd > /dev/null
rm -rf $WORK/tags

if [ -f "$OUT/whitelist.txt" ]; then
  export FUZZALLOC_WHITELIST="$OUT/whitelist.txt"
fi

export CC="$SRC/fuzzalloc-debug/src/tools/dataflow-collect-tag-sites"
export CXX="$SRC/fuzzalloc-debug/src/tools/dataflow-collect-tag-sites++"
export FUZZALLOC_TAG_LOG="$WORK/tag-sites.csv"

echo " done."
